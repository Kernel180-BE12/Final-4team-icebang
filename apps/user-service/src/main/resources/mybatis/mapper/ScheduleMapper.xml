<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="site.icebang.domain.schedule.mapper.ScheduleMapper">

    <resultMap id="scheduleResultMap" type="site.icebang.domain.schedule.model.Schedule">
        <id property="id" column="id"/>
        <result property="workflowId" column="workflow_id"/>
        <result property="cronExpression" column="cron_expression"/>
        <result property="parameters" column="parameters"/>
        <result property="isActive" column="is_active"/>
        <result property="lastRunStatus" column="last_run_status"/>
        <result property="lastRunAt" column="last_run_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="createdBy" column="created_by"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="updatedBy" column="updated_by"/>
        <result property="scheduleText" column="schedule_text"/>
    </resultMap>

    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO schedule (workflow_id, cron_expression, parameters, is_active, schedule_text, created_by, updated_by)
        VALUES (#{workflowId}, #{cronExpression}, #{parameters}, #{isActive}, #{scheduleText}, #{createdBy}, #{updatedBy})
    </insert>

    <update id="update">
        UPDATE schedule
        <set>
            <if test="workflowId != null">workflow_id = #{workflowId},</if>
            <if test="cronExpression != null">cron_expression = #{cronExpression},</if>
            <if test="parameters != null">parameters = #{parameters},</if>
            is_active = #{isActive},
            <if test="lastRunStatus != null">last_run_status = #{lastRunStatus},</if>
            <if test="lastRunAt != null">last_run_at = #{lastRunAt},</if>
            <if test="updatedBy != null">updated_by = #{updatedBy},</if>
            <if test="scheduleText != null">schedule_text = #{scheduleText},</if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}
    </update>

    <select id="findById" resultMap="scheduleResultMap">
        SELECT * FROM schedule WHERE id = #{id}
    </select>

    <select id="findAllActive" resultMap="scheduleResultMap">
        SELECT * FROM schedule WHERE is_active = TRUE
    </select>

</mapper>