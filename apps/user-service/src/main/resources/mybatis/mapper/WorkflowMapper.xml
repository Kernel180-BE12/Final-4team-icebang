<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="site.icebang.domain.workflow.mapper.WorkflowMapper">
    <select id="selectWorkflowList" parameterType="site.icebang.common.dto.PageParams"
            resultType="site.icebang.domain.workflow.dto.WorkflowCardDto">
        SELECT
            w.id,
            w.name,
            w.description,
            w.is_enabled as isEnabled,
            u.name as createdBy,
            w.created_at as createdAt
        FROM workflow w
        LEFT JOIN user u ON w.created_by = u.id
        WHERE 1=1
        ORDER BY w.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="selectWorkflowCount" parameterType="site.icebang.common.dto.PageParams"
            resultType="int">
        SELECT COUNT(*)
        FROM workflow w
        WHERE 1=1
    </select>

    <select id="selectWorkflowById" parameterType="java.math.BigInteger"
            resultType="site.icebang.domain.workflow.dto.WorkflowCardDto">
        SELECT
            w.id,
            w.name,
            w.description,
            w.is_enabled as isEnabled,
            u.name as createdBy,
            w.created_at as createdAt
        FROM workflow w
        LEFT JOIN user u ON w.created_by = u.id
        WHERE w.id = #{id}
    </select>

    <select id="selectWorkflowHistoryList" parameterType="site.icebang.common.dto.PageParams"
            resultType="site.icebang.domain.workflow.dto.WorkflowHistoryDTO">
        SELECT
            wr.id,
            wr.workflow_id,
            wr.trace_id,
            wr.run_number,
            wr.status,
            wr.trigger_type,
            wr.started_at,
            wr.finished_at,
            wr.created_by,
            wr.created_at
        FROM workflow_run wr
        WHERE 1=1
        ORDER BY wr.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="selectWorkflowHistoryCount" parameterType="site.icebang.common.dto.PageParams"
            resultType="int">
        SELECT COUNT(*)
        FROM workflow_run
        WHERE 1=1
    </select>

</mapper>