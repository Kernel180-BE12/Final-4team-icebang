<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="site.icebang.domain.auth.mapper.AuthMapper">

    <select id="existsByEmail" parameterType="string" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM user
            WHERE email = #{email}
        )
    </select>

    <!-- 로그인용 사용자 정보 조회 -->
    <select id="findUserByEmail" parameterType="string" resultType="site.icebang.domain.auth.model.AuthCredential">
        SELECT
            u.id,
            u.email,
            u.password,
            uo.status,
            GROUP_CONCAT(DISTINCT r.name) as roles
        FROM user u
                 LEFT JOIN user_organization uo ON u.id = uo.user_id
                 LEFT JOIN user_role ur ON uo.id = ur.user_organization_id
                 LEFT JOIN role r ON ur.role_id = r.id
        WHERE u.email = #{email}
          AND uo.status IN ('ACTIVE', 'PENDING')
        GROUP BY u.id, u.email, u.password, uo.status
            LIMIT 1
    </select>

    <insert id="insertUser" parameterType="site.icebang.domain.auth.dto.RegisterDto" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user (name, email, password)
        VALUES (#{name}, #{email}, #{password});
    </insert>

    <insert id="insertUserOrganization" parameterType="site.icebang.domain.auth.dto.RegisterDto" useGeneratedKeys="true" keyProperty="userOrgId">
        INSERT INTO user_organization (user_id, organization_id, department_id, position_id, status)
        VALUES (#{id}, #{orgId}, #{deptId}, #{positionId}, #{status});
    </insert>

    <insert id="insertUserRoles" parameterType="site.icebang.domain.auth.dto.RegisterDto">
        INSERT INTO user_role (user_organization_id, role_id)
        VALUES
        <foreach collection="roleIds" item="roleId" separator=",">
            (#{userOrgId}, #{roleId})
        </foreach>
    </insert>

    <select id="findPasswordByEmail" parameterType="string" resultType="string">
        SELECT password
        FROM user
        WHERE email = #{email}
    </select>

    <update id="updatePassword">
        UPDATE user
        SET password = #{newPassword}
        WHERE email = #{email}
    </update>

</mapper>